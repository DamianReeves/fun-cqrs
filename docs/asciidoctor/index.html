<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.2">
<title>Fun.CQRS</title>
<link rel="stylesheet" href="./foundation-potion.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.2.0/css/font-awesome.min.css">
<link rel="stylesheet" href="./pygments-manni.css">
</head>
<body class="article toc2 toc-left">
<div id="header">
<h1>Fun.CQRS</h1>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_introduction">Introduction</a></li>
<li><a href="#_usage_example">Usage Example</a>
<ul class="sectlevel2">
<li><a href="#_type_safe_ids">Type-safe IDs</a></li>
<li><a href="#_lottery_protocol">Lottery Protocol</a></li>
<li><a href="#_coding_the_aggregate">Coding the Aggregate</a></li>
<li><a href="#_aggregate_behavior">Aggregate Behavior</a></li>
<li><a href="#_configuring_the_aggregate">Configuring the Aggregate</a></li>
<li><a href="#_using_the_aggregate">Using the Aggregate</a></li>
</ul>
</li>
<li><a href="#_projections">Projections</a></li>
<li><a href="#_akka_backend_configuration">Akka Backend Configuration</a></li>
<li><a href="#_testing">Testing</a></li>
<li><a href="#_project_information">Project Information</a>
<ul class="sectlevel2">
<li><a href="#_project_artifact">Project artifact</a></li>
<li><a href="#_license">License</a></li>
<li><a href="#_contribution_policy">Contribution policy</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="_introduction">Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p><strong>Fun.CQRS</strong> is a Scala library for building CQRS/ES application. It provides the basic blocks to build event driven aggregates with <strong>Event Sourcing</strong>.</p>
</div>
<div class="paragraph">
<p><strong>Fun.CQRS</strong> provides a out-of-the-box <code>AkkaBackend</code> and a <code>InMemoryBackend</code> for testing. However, it&#8217;s designed as such that other backend implementations are possible. For instance, an alternative Akka backend based on <a href="https://github.com/RBMHTechnology/eventuate" target="_blank">Eventuate</a>, a Slick backend or RxScala backend could be implementated and plugged in easily.</p>
</div>
<div class="paragraph">
<p>When using the <code>AkkaBackend</code>, Aggregates are immutable classes (case class) that live inside an <code>Actor</code>. You don&#8217;t have to deal much with Akka and it&#8217;s powerful abstractions, instead you concentrate in modeling your aggregate behavior and its protocol (<code>Commands</code> and <code>Events</code>). However you still need a minimal understanding of how Akka works and how to configure Akka Persistence to use your persistence plugin of choice.</p>
</div>
<div class="paragraph">
<p>That said, in <strong>Fun.CQRS</strong>, Aggregates are NOT Actors. The <strong>Actor System</strong> is used as a middleware to manage the aggregates, hold them in-memory, store events, recover aggregate states and generate read models via  <strong>Events Projections</strong></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_usage_example">Usage Example</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In the following section we will build a simple aggregate. As an example use case we build a <strong>Lottery</strong> application. This example is also available as a running sample application in the project repository in <a href="https://github.com/strongtyped/fun-cqrs">GitHub</a>.</p>
</div>
<div class="paragraph">
<p>A <strong>Lottery</strong> application has the following requirements:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>An user can create a new lottery game</p>
</li>
<li>
<p>An user can add participants<br>
<strong>condition</strong>: a participant can only be added once<br>
<strong>condition</strong>: a participant can only be added if a winner is not yet selected<br></p>
</li>
<li>
<p>An user can remove a participant<br>
<strong>condition</strong>: if a winner is not yet selected<br></p>
</li>
<li>
<p>An user can remove all participants<br>
<strong>condition</strong>: if a winner is not yet selected<br></p>
</li>
<li>
<p>A user can run the lottery which will select a winner<br>
<strong>condition</strong>: we can only select a winner if there is at least one participant<br>
<strong>condition</strong>: we can only select a winner once, afterwards an error is produced when trying to select a new winner<br></p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_type_safe_ids">Type-safe IDs</h3>
<div class="paragraph">
<p><strong>Fun.CQRS</strong> uses type-safe IDs for aggregates. The ID itself must be of type String, but it must be wrapped in a aggregate specific ID type to be used by the system. As such, we avoid ID clashing and it provides better logging as we can clearly see in the logs from each aggregate it comes from.</p>
</div>
<div class="paragraph">
<p>First we define a type representing the Aggregate ID. We define it by extending the trait <code>io.funcqrs.AggregateId</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="scala"><span class="tok-k">import</span> <span class="tok-nn">io.funcqrs.AggregateId</span>
<span class="tok-k">case</span> <span class="tok-k">class</span> <span class="tok-nc">LotteryId</span><span class="tok-o">(</span><span class="tok-n">value</span><span class="tok-k">:</span> <span class="tok-kt">String</span><span class="tok-o">)</span> <span class="tok-k">extends</span> <span class="tok-nc">AggregateId</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>(ref: <a href="https://github.com/strongtyped/fun-cqrs/blob/master/samples/lottery/src/main/scala/lottery/domain/model/Lottery.scala" target="_blank">Lottery.scala</a>)</p>
</div>
</div>
<div class="sect2">
<h3 id="_lottery_protocol">Lottery Protocol</h3>
<div class="paragraph">
<p>Next we define a Protocol for a Lottery.</p>
</div>
<div class="paragraph">
<p>A <code>Protocol</code> is the set of <code>Commands</code> and <code>Events</code> for a given Aggregate. An Aggregate can only receive <code>Commands</code> from its <code>Protocol</code>. Its command handlers can only emit <code>Events</code> that belong to this same <code>Protocol</code>. And finally, event listeners that will instantiate or update an <code>Aggregate</code> can only react to <code>Events</code> define by the <code>Protocol</code>.</p>
</div>
<div class="paragraph">
<p>Therefore, an Aggregate&#8217;s Protocol defines the totallity of operations and effects of a given Aggregate.</p>
</div>
<div class="paragraph">
<p>The code below demonstrates how to define a protocol.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="scala"><span class="tok-k">import</span> <span class="tok-nn">io.funcqrs._</span>
<span class="tok-k">object</span> <span class="tok-nc">LotteryProtocol</span> <span class="tok-k">extends</span> <span class="tok-nc">ProtocolLike</span> <span class="tok-o">{</span> <span class="tok-c1">// </span><i class="conum" data-value="1"></i><b>(1)</b>

  <span class="tok-c1">// Commands ============================================================</span>
  <span class="tok-k">sealed</span> <span class="tok-k">trait</span> <span class="tok-nc">LotteryCommand</span> <span class="tok-k">extends</span> <span class="tok-nc">ProtocolCommand</span> <span class="tok-c1">// </span><i class="conum" data-value="2"></i><b>(2)</b>

  <span class="tok-c1">// Creation Command</span>
  <span class="tok-k">case</span> <span class="tok-k">class</span> <span class="tok-nc">CreateLottery</span><span class="tok-o">(</span><span class="tok-n">name</span><span class="tok-k">:</span> <span class="tok-kt">String</span><span class="tok-o">)</span> <span class="tok-k">extends</span> <span class="tok-nc">LotteryCommand</span>

  <span class="tok-c1">// Update Commands</span>
  <span class="tok-k">case</span> <span class="tok-k">class</span> <span class="tok-nc">AddParticipant</span><span class="tok-o">(</span><span class="tok-n">name</span><span class="tok-k">:</span> <span class="tok-kt">String</span><span class="tok-o">)</span> <span class="tok-k">extends</span> <span class="tok-nc">LotteryCommand</span>

  <span class="tok-k">case</span> <span class="tok-k">class</span> <span class="tok-nc">RemoveParticipant</span><span class="tok-o">(</span><span class="tok-n">name</span><span class="tok-k">:</span> <span class="tok-kt">String</span><span class="tok-o">)</span> <span class="tok-k">extends</span> <span class="tok-nc">LotteryCommand</span>

  <span class="tok-k">case</span> <span class="tok-k">object</span> <span class="tok-nc">RemoveAllParticipants</span> <span class="tok-k">extends</span> <span class="tok-nc">LotteryCommand</span>

  <span class="tok-k">case</span> <span class="tok-k">object</span> <span class="tok-nc">Run</span> <span class="tok-k">extends</span> <span class="tok-nc">LotteryCommand</span>

  <span class="tok-c1">// Events ============================================================</span>
  <span class="tok-k">sealed</span> <span class="tok-k">trait</span> <span class="tok-nc">LotteryEvent</span> <span class="tok-k">extends</span> <span class="tok-nc">ProtocolEvent</span> <span class="tok-k">with</span> <span class="tok-nc">MetadataFacet</span><span class="tok-o">[</span><span class="tok-kt">LotteryMetadata</span><span class="tok-o">]</span> <span class="tok-c1">// </span><i class="conum" data-value="3"></i><b>(3)</b>

  <span class="tok-k">case</span> <span class="tok-k">class</span> <span class="tok-nc">LotteryMetadata</span><span class="tok-o">(</span> <span class="tok-c1">// </span><i class="conum" data-value="4"></i><b>(4)</b>
      <span class="tok-n">aggregateId</span><span class="tok-k">:</span> <span class="tok-kt">LotteryId</span><span class="tok-o">,</span> <span class="tok-c1">// </span><i class="conum" data-value="5"></i><b>(5)</b>
      <span class="tok-n">commandId</span><span class="tok-k">:</span> <span class="tok-kt">CommandId</span><span class="tok-o">,</span> <span class="tok-c1">// </span><i class="conum" data-value="6"></i><b>(6)</b>
      <span class="tok-n">eventId</span><span class="tok-k">:</span> <span class="tok-kt">EventId</span> <span class="tok-o">=</span> <span class="tok-nc">EventId</span><span class="tok-o">(),</span> <span class="tok-c1">// </span><i class="conum" data-value="7"></i><b>(7)</b>
      <span class="tok-n">date</span><span class="tok-k">:</span> <span class="tok-kt">OffsetDateTime</span> <span class="tok-o">=</span> <span class="tok-nc">OffsetDateTime</span><span class="tok-o">.</span><span class="tok-n">now</span><span class="tok-o">(),</span> <span class="tok-c1">// </span><i class="conum" data-value="8"></i><b>(8)</b>
      <span class="tok-n">tags</span><span class="tok-k">:</span> <span class="tok-kt">Set</span><span class="tok-o">[</span><span class="tok-kt">Tag</span><span class="tok-o">]</span> <span class="tok-k">=</span> <span class="tok-nc">Set</span><span class="tok-o">()</span> <span class="tok-c1">// </span><i class="conum" data-value="9"></i><b>(9)</b>
  <span class="tok-o">)</span> <span class="tok-k">extends</span> <span class="tok-nc">Metadata</span> <span class="tok-k">with</span> <span class="tok-nc">JavaTime</span> <span class="tok-o">{</span>
    <span class="tok-k">type</span> <span class="tok-kt">Id</span> <span class="tok-o">=</span> <span class="tok-nc">LotteryId</span>
  <span class="tok-o">}</span>

  <span class="tok-c1">// Creation Event</span>
  <span class="tok-k">case</span> <span class="tok-k">class</span> <span class="tok-nc">LotteryCreated</span><span class="tok-o">(</span><span class="tok-n">name</span><span class="tok-k">:</span> <span class="tok-kt">String</span><span class="tok-o">,</span> <span class="tok-n">metadata</span><span class="tok-k">:</span> <span class="tok-kt">LotteryMetadata</span><span class="tok-o">)</span> <span class="tok-k">extends</span> <span class="tok-nc">LotteryEvent</span>

  <span class="tok-c1">// Update Events</span>
  <span class="tok-k">sealed</span> <span class="tok-k">trait</span> <span class="tok-nc">LotteryUpdateEvent</span> <span class="tok-k">extends</span> <span class="tok-nc">LotteryEvent</span>

  <span class="tok-k">case</span> <span class="tok-k">class</span> <span class="tok-nc">ParticipantAdded</span><span class="tok-o">(</span><span class="tok-n">name</span><span class="tok-k">:</span> <span class="tok-kt">String</span><span class="tok-o">,</span> <span class="tok-n">metadata</span><span class="tok-k">:</span> <span class="tok-kt">LotteryMetadata</span><span class="tok-o">)</span> <span class="tok-k">extends</span> <span class="tok-nc">LotteryUpdateEvent</span>

  <span class="tok-k">case</span> <span class="tok-k">class</span> <span class="tok-nc">ParticipantRemoved</span><span class="tok-o">(</span><span class="tok-n">name</span><span class="tok-k">:</span> <span class="tok-kt">String</span><span class="tok-o">,</span> <span class="tok-n">metadata</span><span class="tok-k">:</span> <span class="tok-kt">LotteryMetadata</span><span class="tok-o">)</span> <span class="tok-k">extends</span> <span class="tok-nc">LotteryUpdateEvent</span>

  <span class="tok-k">case</span> <span class="tok-k">class</span> <span class="tok-nc">WinnerSelected</span><span class="tok-o">(</span><span class="tok-n">winner</span><span class="tok-k">:</span> <span class="tok-kt">String</span><span class="tok-o">,</span> <span class="tok-n">metadata</span><span class="tok-k">:</span> <span class="tok-kt">LotteryMetadata</span><span class="tok-o">)</span> <span class="tok-k">extends</span> <span class="tok-nc">LotteryUpdateEvent</span>

<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>(ref: <a href="https://github.com/strongtyped/fun-cqrs/blob/master/samples/lottery/src/main/scala/lottery/domain/model/Lottery.scala" target="_blank">Lottery.scala</a>)</p>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>A Protocol is defined as a Scala object (not a class) and it extends the trait <code>io.funcqrs.ProtocolLike</code>.<br>
<code>ProtocolLike</code> trait brings two new traits in scope: <code>ProtocolCommand</code> and <code>ProtocolEvent</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Each Lottery Command extends <code>ProtocolCommand</code> via sealed trait <code>LotteryCommnad</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Each Lottery Event extends <code>ProtocolEvent</code> via sealed trait <code>LotteryEvent</code>.<br>
<code>LotteryEvent</code> is enriched (via <code>MetadataFacet</code>) with <code>LotteryMetadata</code>.
The <code>LotteryMetadata</code> has some basic information about the event, for instance:</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The <code>AggregateId</code> for each it was generated.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>The <code>CommandId</code> that originated the <code>Event</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>A unique <code>EventId</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>The event date time.</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>One or more <code>Tags</code>  (we&#8217;ll see later why tagging is important).</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_coding_the_aggregate">Coding the Aggregate</h3>
<div class="paragraph">
<p>The next step is to code the  aggregate itself.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="scala"><span class="tok-k">import</span> <span class="tok-nn">io.funcqrs.AggregateLike</span>
<span class="tok-k">case</span> <span class="tok-k">class</span> <span class="tok-nc">Lottery</span><span class="tok-o">(</span>
    <span class="tok-n">name</span><span class="tok-k">:</span> <span class="tok-kt">String</span><span class="tok-o">,</span>
    <span class="tok-n">participants</span><span class="tok-k">:</span> <span class="tok-kt">List</span><span class="tok-o">[</span><span class="tok-kt">String</span><span class="tok-o">]</span> <span class="tok-k">=</span> <span class="tok-nc">List</span><span class="tok-o">(),</span>
    <span class="tok-n">winner</span><span class="tok-k">:</span> <span class="tok-kt">Option</span><span class="tok-o">[</span><span class="tok-kt">String</span><span class="tok-o">]</span> <span class="tok-k">=</span> <span class="tok-nc">None</span><span class="tok-o">,</span>
    <span class="tok-n">id</span><span class="tok-k">:</span> <span class="tok-kt">LotteryId</span>
<span class="tok-o">)</span> <span class="tok-k">extends</span> <span class="tok-nc">AggregateLike</span> <span class="tok-o">{</span>

  <span class="tok-k">type</span> <span class="tok-kt">Id</span> <span class="tok-o">=</span> <span class="tok-nc">LotteryId</span> <span class="tok-c1">// </span><i class="conum" data-value="1"></i><b>(1)</b>
  <span class="tok-k">type</span> <span class="tok-kt">Protocol</span> <span class="tok-o">=</span> <span class="tok-nc">LotteryProtocol</span><span class="tok-o">.</span><span class="tok-k">type</span> <span class="tok-kt">//</span> <i class="conum" data-value="2"></i><b>(2)</b>

  <span class="tok-k">def</span> <span class="tok-n">addParticipant</span><span class="tok-o">(</span><span class="tok-n">name</span><span class="tok-k">:</span> <span class="tok-kt">String</span><span class="tok-o">)</span><span class="tok-k">:</span> <span class="tok-kt">Lottery</span> <span class="tok-o">=</span> <span class="tok-o">{</span>
    <span class="tok-n">copy</span><span class="tok-o">(</span><span class="tok-n">participants</span> <span class="tok-k">=</span> <span class="tok-n">participants</span> <span class="tok-o">:+</span> <span class="tok-n">name</span><span class="tok-o">)</span>
  <span class="tok-o">}</span>

  <span class="tok-k">def</span> <span class="tok-n">removeParticipant</span><span class="tok-o">(</span><span class="tok-n">name</span><span class="tok-k">:</span> <span class="tok-kt">String</span><span class="tok-o">)</span><span class="tok-k">:</span> <span class="tok-kt">Lottery</span> <span class="tok-o">=</span> <span class="tok-o">{</span>
    <span class="tok-n">copy</span><span class="tok-o">(</span><span class="tok-n">participants</span> <span class="tok-k">=</span> <span class="tok-n">participants</span><span class="tok-o">.</span><span class="tok-n">filter</span><span class="tok-o">(</span><span class="tok-k">_</span> <span class="tok-o">!=</span> <span class="tok-n">name</span><span class="tok-o">))</span>
  <span class="tok-o">}</span>

  <span class="tok-k">def</span> <span class="tok-n">selectParticipant</span><span class="tok-o">()</span><span class="tok-k">:</span> <span class="tok-kt">String</span> <span class="tok-o">=</span> <span class="tok-o">{</span>
    <span class="tok-k">val</span> <span class="tok-n">index</span> <span class="tok-k">=</span> <span class="tok-nc">Random</span><span class="tok-o">.</span><span class="tok-n">nextInt</span><span class="tok-o">(</span><span class="tok-n">participants</span><span class="tok-o">.</span><span class="tok-n">size</span><span class="tok-o">)</span>
    <span class="tok-n">participants</span><span class="tok-o">(</span><span class="tok-n">index</span><span class="tok-o">)</span>
  <span class="tok-o">}</span>

  <span class="tok-k">def</span> <span class="tok-n">hasWinner</span> <span class="tok-k">=</span> <span class="tok-n">winner</span><span class="tok-o">.</span><span class="tok-n">isDefined</span>

  <span class="tok-k">def</span> <span class="tok-n">hasNoParticipants</span> <span class="tok-k">=</span> <span class="tok-n">participants</span><span class="tok-o">.</span><span class="tok-n">isEmpty</span>

  <span class="tok-k">def</span> <span class="tok-n">hasParticipant</span><span class="tok-o">(</span><span class="tok-n">name</span><span class="tok-k">:</span> <span class="tok-kt">String</span><span class="tok-o">)</span> <span class="tok-k">=</span> <span class="tok-n">participants</span><span class="tok-o">.</span><span class="tok-n">contains</span><span class="tok-o">(</span><span class="tok-n">name</span><span class="tok-o">)</span>

  <span class="tok-k">def</span> <span class="tok-n">isNewParticipant</span><span class="tok-o">(</span><span class="tok-n">name</span><span class="tok-k">:</span> <span class="tok-kt">String</span><span class="tok-o">)</span> <span class="tok-k">=</span> <span class="tok-o">!</span><span class="tok-n">hasParticipant</span><span class="tok-o">(</span><span class="tok-n">name</span><span class="tok-o">)</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>(ref: <a href="https://github.com/strongtyped/fun-cqrs/blob/master/samples/lottery/src/main/scala/lottery/domain/model/Lottery.scala" target="_blank">Lottery.scala</a>)</p>
</div>
<div class="paragraph">
<p>We define the <strong>Lottery</strong> aggregate by extending the trait <code>io.funcqrs.AggregateLike</code>. As a consequence we need to define two type members:</p>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>Id</code> which should point to an <code>AggregateId</code>. In our case the previously defined <code>LotteryId</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The <code>Protocol</code> which in our case will point to <code>LotteryProtocol</code>. Remember: <code>LotteryProtocol</code> is an object. To access its type we must write <code>LotteryProtocol.type</code>. <code>LotteryProtocol</code> gives us the object singleton instance.</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The <code>Lottery</code> aggregate is a simple case class with methods to 'modify' its state by copying the case class and returning it. It does NOT check the invariants of the aggregate <code>Lottery</code> and it doesn&#8217;t work at the level of <code>Commands</code> and <code>Events</code>. This is rather a design choice. Nothing forbid us to have <code>Lottery</code> reacting direct to <code>Commands</code> and <code>Events</code> and enforcing its invariants.</p>
</div>
<div class="paragraph">
<p>For this example we will keep it as a mere data container of the aggregate state. The invariants will be enforced by the <code>Behavior</code> we will implement in the next section.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_aggregate_behavior">Aggregate Behavior</h3>
<div class="paragraph">
<p>Up to now, we have an Aggregate with a type-safe <strong>Id</strong> and its <strong>Protocol</strong> defining all possible <code>Commands</code> and <code>Evetns</code>. We still need a way to bind each <code>Command</code> to the right operation in the aggregate, let it produces the right <code>Events</code> and react to the <code>Events</code> accordingly. That all respecting the invariants of the <code>Lottery</code> aggregate.</p>
</div>
<div class="paragraph">
<p>The <code>Behavior</code> can be define by means of a declarative <strong>DSL</strong>. It is defined in terms of <code>Bindings</code>. A <code>Binding</code> describe the different <strong>Command Handlers</strong> and <strong>Event Listerners</strong>.</p>
</div>
<div class="paragraph">
<p>There are two kinds of <strong>Command Handlers</strong>. Handlers that produce <code>Events</code> and handlers that reject commands, also know as 'guard clauses'.</p>
</div>
<div class="paragraph">
<p>We also make a distinction between <code>Commands</code> and <code>Events</code> that instantiate an Aggregate (creational <code>Commands</code> and <code>Events</code>) and those that must be validated against an existing Aggregate instance (update <code>Commands</code> and <code>Events</code>). This is done by defining the <code>Bindings</code> both situations. We have <code>Bindings</code> for when the aggregate is <code>Uninitialized</code> and for when it&#8217;s already <code>Initialized</code>.</p>
</div>
<div class="paragraph">
<p>The code below demonstrate how we can build a <code>Behavior</code> with the help of the <strong>Behavior DSL</strong>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="scala"><span class="tok-k">import</span> <span class="tok-nn">io.funcqrs.behavior.Behavior</span>
<span class="tok-k">import</span> <span class="tok-nn">io.funcqrs.dsl.BehaviorDsl.api._</span>
<span class="tok-k">object</span> <span class="tok-nc">Lottery</span> <span class="tok-o">{</span>

  <span class="tok-c1">// import the protocol to have access to Commands and Events</span>
  <span class="tok-k">import</span> <span class="tok-nn">LotteryProtocol._</span>

  <span class="tok-c1">// a tag for lottery, useful to query the event store later on</span>
  <span class="tok-k">val</span> <span class="tok-n">tag</span> <span class="tok-k">=</span> <span class="tok-nc">Tags</span><span class="tok-o">.</span><span class="tok-n">aggregateTag</span><span class="tok-o">(</span><span class="tok-s">&quot;lottery&quot;</span><span class="tok-o">)</span>

  <span class="tok-k">def</span> <span class="tok-n">behavior</span><span class="tok-o">(</span><span class="tok-n">lotteryId</span><span class="tok-k">:</span> <span class="tok-kt">LotteryId</span><span class="tok-o">)</span><span class="tok-k">:</span> <span class="tok-kt">Behavior</span><span class="tok-o">[</span><span class="tok-kt">Lottery</span><span class="tok-o">]</span> <span class="tok-k">=</span> <span class="tok-o">{</span>

    <span class="tok-c1">// convenient method for building LotteryMetatadata</span>
    <span class="tok-k">def</span> <span class="tok-n">metadata</span><span class="tok-o">(</span><span class="tok-n">cmd</span><span class="tok-k">:</span> <span class="tok-kt">LotteryCommand</span><span class="tok-o">)</span> <span class="tok-k">=</span> <span class="tok-o">{</span>
      <span class="tok-nc">LotteryMetadata</span><span class="tok-o">(</span><span class="tok-n">lotteryId</span><span class="tok-o">,</span> <span class="tok-n">cmd</span><span class="tok-o">.</span><span class="tok-n">id</span><span class="tok-o">,</span> <span class="tok-n">tags</span> <span class="tok-k">=</span> <span class="tok-nc">Set</span><span class="tok-o">(</span><span class="tok-n">tag</span><span class="tok-o">))</span>
    <span class="tok-o">}</span>

    <span class="tok-n">behaviorOf</span><span class="tok-o">[</span><span class="tok-kt">Lottery</span><span class="tok-o">]</span> <span class="tok-n">when</span> <span class="tok-o">{</span>

      <span class="tok-k">case</span> <span class="tok-nc">Uninitialized</span> <span class="tok-k">=&gt;</span> <span class="tok-c1">// </span><i class="conum" data-value="1"></i><b>(1)</b>

        <span class="tok-n">bind</span><span class="tok-o">[</span><span class="tok-kt">Lottery</span><span class="tok-o">]</span>
          <span class="tok-o">.</span><span class="tok-n">handler</span> <span class="tok-o">{</span>
            <span class="tok-n">cmd</span><span class="tok-k">:</span> <span class="tok-kt">CreateLottery</span> <span class="tok-o">=&gt;</span> <span class="tok-nc">LotteryCreated</span><span class="tok-o">(</span><span class="tok-n">cmd</span><span class="tok-o">.</span><span class="tok-n">name</span><span class="tok-o">,</span> <span class="tok-n">metadata</span><span class="tok-o">(</span><span class="tok-n">cmd</span><span class="tok-o">))</span>
          <span class="tok-o">}</span> <span class="tok-n">listener</span> <span class="tok-o">{</span>
            <span class="tok-n">evt</span><span class="tok-k">:</span> <span class="tok-kt">LotteryCreated</span> <span class="tok-o">=&gt;</span> <span class="tok-nc">Lottery</span><span class="tok-o">(</span><span class="tok-n">name</span> <span class="tok-k">=</span> <span class="tok-n">evt</span><span class="tok-o">.</span><span class="tok-n">name</span><span class="tok-o">,</span> <span class="tok-n">id</span> <span class="tok-k">=</span> <span class="tok-n">lotteryId</span><span class="tok-o">)</span>
          <span class="tok-o">}</span>

      <span class="tok-k">case</span> <span class="tok-nc">Initialized</span><span class="tok-o">(</span><span class="tok-n">lottery</span><span class="tok-o">)</span> <span class="tok-k">=&gt;</span> <span class="tok-c1">// </span><i class="conum" data-value="2"></i><b>(2)</b>

        <span class="tok-n">bind</span><span class="tok-o">[</span><span class="tok-kt">Lottery</span><span class="tok-o">]</span>
          <span class="tok-c1">// Some guard clauses.</span>
          <span class="tok-c1">// Commands bellow won&#39;t generate events, but be reject with an exception</span>
          <span class="tok-o">.</span><span class="tok-n">reject</span> <span class="tok-o">{</span> <span class="tok-c1">// </span><i class="conum" data-value="3"></i><b>(3)</b>
            <span class="tok-c1">// no command can be accepted after having selected a winner</span>
            <span class="tok-k">case</span> <span class="tok-n">anyCommand</span> <span class="tok-k">if</span> <span class="tok-n">lottery</span><span class="tok-o">.</span><span class="tok-n">hasWinner</span> <span class="tok-k">=&gt;</span>
              <span class="tok-k">new</span> <span class="tok-nc">IllegalArgumentException</span><span class="tok-o">(</span><span class="tok-s">&quot;Lottery has already a winner!&quot;</span><span class="tok-o">)</span>
          <span class="tok-o">}</span>
          <span class="tok-o">.</span><span class="tok-n">reject</span> <span class="tok-o">{</span>
            <span class="tok-c1">// can&#39;t run if there is no participants</span>
            <span class="tok-k">case</span> <span class="tok-k">_:</span> <span class="tok-kt">Run.</span><span class="tok-k">type</span> <span class="tok-kt">if</span> <span class="tok-kt">lottery.hasNoParticipants</span> <span class="tok-o">=&gt;</span>
              <span class="tok-k">new</span> <span class="tok-nc">IllegalArgumentException</span><span class="tok-o">(</span><span class="tok-s">&quot;Lottery has no participants&quot;</span><span class="tok-o">)</span>
          <span class="tok-o">}</span>
          <span class="tok-o">.</span><span class="tok-n">reject</span> <span class="tok-o">{</span>
            <span class="tok-c1">// can&#39;t add participant twice</span>
            <span class="tok-k">case</span> <span class="tok-n">cmd</span><span class="tok-k">:</span> <span class="tok-kt">AddParticipant</span> <span class="tok-kt">if</span> <span class="tok-kt">lottery.hasParticipant</span><span class="tok-o">(</span><span class="tok-kt">cmd.name</span><span class="tok-o">)</span> <span class="tok-o">=&gt;</span>
              <span class="tok-k">new</span> <span class="tok-nc">IllegalArgumentException</span><span class="tok-o">(</span><span class="tok-n">s</span><span class="tok-s">&quot;Participant ${cmd.name} already added!&quot;</span><span class="tok-o">)</span>
          <span class="tok-o">}</span>

          <span class="tok-c1">// Logic to update a lottery. Commands bellow will generate events</span>

          <span class="tok-c1">// running a lottery</span>
          <span class="tok-o">.</span><span class="tok-n">handler</span> <span class="tok-o">{</span> <span class="tok-c1">// </span><i class="conum" data-value="4"></i><b>(4)</b>
            <span class="tok-n">cmd</span><span class="tok-k">:</span> <span class="tok-kt">Run.</span><span class="tok-k">type</span> <span class="tok-o">=&gt;</span> <span class="tok-nc">WinnerSelected</span><span class="tok-o">(</span><span class="tok-n">lottery</span><span class="tok-o">.</span><span class="tok-n">selectParticipant</span><span class="tok-o">(),</span> <span class="tok-n">metadata</span><span class="tok-o">(</span><span class="tok-n">cmd</span><span class="tok-o">))</span>
          <span class="tok-o">}</span>
          <span class="tok-o">.</span><span class="tok-n">listener</span> <span class="tok-o">{</span>
            <span class="tok-n">evt</span><span class="tok-k">:</span> <span class="tok-kt">WinnerSelected</span> <span class="tok-o">=&gt;</span> <span class="tok-n">lottery</span><span class="tok-o">.</span><span class="tok-n">copy</span><span class="tok-o">(</span><span class="tok-n">winner</span> <span class="tok-k">=</span> <span class="tok-nc">Option</span><span class="tok-o">(</span><span class="tok-n">evt</span><span class="tok-o">.</span><span class="tok-n">winner</span><span class="tok-o">))</span>
          <span class="tok-o">}</span>


          <span class="tok-c1">// adding participant</span>
          <span class="tok-o">.</span><span class="tok-n">handler</span> <span class="tok-o">{</span>
            <span class="tok-n">cmd</span><span class="tok-k">:</span> <span class="tok-kt">AddParticipant</span> <span class="tok-o">=&gt;</span> <span class="tok-nc">ParticipantAdded</span><span class="tok-o">(</span><span class="tok-n">cmd</span><span class="tok-o">.</span><span class="tok-n">name</span><span class="tok-o">,</span> <span class="tok-n">metadata</span><span class="tok-o">(</span><span class="tok-n">cmd</span><span class="tok-o">))</span>
          <span class="tok-o">}</span>
          <span class="tok-o">.</span><span class="tok-n">listener</span> <span class="tok-o">{</span>
            <span class="tok-n">evt</span><span class="tok-k">:</span> <span class="tok-kt">ParticipantAdded</span> <span class="tok-o">=&gt;</span> <span class="tok-n">lottery</span><span class="tok-o">.</span><span class="tok-n">addParticipant</span><span class="tok-o">(</span><span class="tok-n">evt</span><span class="tok-o">.</span><span class="tok-n">name</span><span class="tok-o">)</span>
          <span class="tok-o">}</span>

          <span class="tok-c1">// removing participants (single or all) produce ParticipantRemoved events</span>
          <span class="tok-o">.</span><span class="tok-n">handler</span> <span class="tok-o">{</span>
            <span class="tok-n">cmd</span><span class="tok-k">:</span> <span class="tok-kt">RemoveParticipant</span> <span class="tok-o">=&gt;</span> <span class="tok-nc">ParticipantRemoved</span><span class="tok-o">(</span><span class="tok-n">cmd</span><span class="tok-o">.</span><span class="tok-n">name</span><span class="tok-o">,</span> <span class="tok-n">metadata</span><span class="tok-o">(</span><span class="tok-n">cmd</span><span class="tok-o">))</span>
          <span class="tok-o">}</span>
          <span class="tok-o">.</span><span class="tok-n">handler</span><span class="tok-o">.</span><span class="tok-n">manyEvents</span> <span class="tok-o">{</span> <span class="tok-c1">// </span><i class="conum" data-value="5"></i><b>(5)</b>
            <span class="tok-c1">// will produce a List[ParticipantRemoved]</span>
            <span class="tok-n">cmd</span><span class="tok-k">:</span> <span class="tok-kt">RemoveAllParticipants.</span><span class="tok-k">type</span> <span class="tok-o">=&gt;</span>
              <span class="tok-n">lottery</span><span class="tok-o">.</span><span class="tok-n">participants</span><span class="tok-o">.</span><span class="tok-n">map</span> <span class="tok-o">{</span> <span class="tok-n">name</span> <span class="tok-k">=&gt;</span> <span class="tok-nc">ParticipantRemoved</span><span class="tok-o">(</span><span class="tok-n">name</span><span class="tok-o">,</span> <span class="tok-n">metadata</span><span class="tok-o">(</span><span class="tok-n">cmd</span><span class="tok-o">))</span> <span class="tok-o">}</span>
          <span class="tok-o">}</span>
          <span class="tok-o">.</span><span class="tok-n">listener</span> <span class="tok-o">{</span>
            <span class="tok-n">evt</span><span class="tok-k">:</span> <span class="tok-kt">ParticipantRemoved</span> <span class="tok-o">=&gt;</span> <span class="tok-n">lottery</span><span class="tok-o">.</span><span class="tok-n">removeParticipant</span><span class="tok-o">(</span><span class="tok-n">evt</span><span class="tok-o">.</span><span class="tok-n">name</span><span class="tok-o">)</span>
          <span class="tok-o">}</span>
    <span class="tok-o">}</span>

  <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>(ref: <a href="https://github.com/strongtyped/fun-cqrs/blob/master/samples/lottery/src/main/scala/lottery/domain/model/Lottery.scala" target="_blank">Lottery.scala</a>)</p>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>Uninitialized</code> case defines <strong>Command Handlers</strong> and <strong>Event Listeners</strong> responsible for initialising a <code>Lottery</code> aggregate. You can defined as many as you want, but typically there is only one <strong>handler</strong> and one <strong>listener</strong>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>Initialized</code> case defines <strong>Command Handlers</strong> and <strong>Event Listeners</strong> responsible for updating an existent Aggregate instance. Note that the current lottery state is made available in scope by pattern machting on <code>Initialized(lottery)</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><code>reject</code> handlers are <strong>command handlers</strong> that reject a <code>Command</code> if a given condition is fulfilled. Note that <code>reject</code> handlers are defined using <code>PartialFunctions</code> and typically they include a 'guard' per case.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Different <strong>Command Handlers</strong> and <strong>Event Listeners</strong> may be defined.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>In some situations, an <code>Command</code> may produce more than one <code>Event</code>. In that case, we must call <code>handler.manyEvents</code> instead an pass a function that returns a <code>List[Event]</code></td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_configuring_the_aggregate">Configuring the Aggregate</h3>
<div class="paragraph">
<p>In this last step we configure the <strong>Akka Backend</strong> with our <strong>Lottery</strong> aggregate. the configuration is quite straight forward.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="scala"><span class="tok-k">import</span> <span class="tok-nn">io.funcqrs.backend.akka.api._</span>
<span class="tok-k">import</span> <span class="tok-nn">akka.actor.ActorSystem</span>
<span class="tok-k">import</span> <span class="tok-nn">lottery.domain.model.Lottery</span>
<span class="tok-k">import</span> <span class="tok-nn">io.funcqrs.backend.akka.AggregateService</span>


  <span class="tok-k">val</span> <span class="tok-n">backend</span> <span class="tok-k">=</span> <span class="tok-k">new</span> <span class="tok-nc">AkkaBackend</span> <span class="tok-o">{</span> <span class="tok-c1">// </span><i class="conum" data-value="1"></i><b>(1)</b>

    <span class="tok-c1">// override this val in order to use another ActorSystem</span>
    <span class="tok-c1">// override val actorSystem: ActorSystem = ??? // </span><i class="conum" data-value="2"></i><b>(2)</b>


    <span class="tok-k">def</span> <span class="tok-n">sourceProvider</span><span class="tok-o">(</span><span class="tok-n">query</span><span class="tok-k">:</span> <span class="tok-kt">Query</span><span class="tok-o">)</span><span class="tok-k">:</span> <span class="tok-kt">EventsSourceProvider</span> <span class="tok-o">=</span> <span class="tok-o">{</span> <span class="tok-c1">// </span><i class="conum" data-value="3"></i><b>(3)</b>
      <span class="tok-n">query</span> <span class="tok-k">match</span> <span class="tok-o">{</span>
        <span class="tok-k">case</span> <span class="tok-nc">QueryByTag</span><span class="tok-o">(</span><span class="tok-n">tag</span><span class="tok-o">)</span> <span class="tok-k">=&gt;</span> <span class="tok-k">new</span> <span class="tok-nc">LevelDbTaggedEventsSource</span><span class="tok-o">(</span><span class="tok-n">tag</span><span class="tok-o">)</span>
      <span class="tok-o">}</span>
    <span class="tok-o">}</span>
  <span class="tok-o">}</span>

  <span class="tok-k">val</span> <span class="tok-n">lotteryViewRepo</span> <span class="tok-k">=</span> <span class="tok-k">new</span> <span class="tok-nc">LotteryViewRepo</span>

  <span class="tok-n">backend</span>
    <span class="tok-c1">// ---------------------------------------------</span>
    <span class="tok-c1">// aggregate config - write model</span>
    <span class="tok-o">.</span><span class="tok-n">configure</span> <span class="tok-o">{</span>
      <span class="tok-n">aggregate</span><span class="tok-o">[</span><span class="tok-kt">Lottery</span><span class="tok-o">](</span><span class="tok-nc">Lottery</span><span class="tok-o">.</span><span class="tok-n">behavior</span><span class="tok-o">)</span> <span class="tok-c1">// </span><i class="conum" data-value="4"></i><b>(4)</b>
    <span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>(ref: <a href="https://github.com/strongtyped/fun-cqrs/tree/master/samples/lottery/src/main/scala/lottery/app/Main.scala" target="_blank">Main.scala</a>)</p>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We create an <code>AkkaBackend</code> in-place.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The <code>AkkaBackend</code> will start its own <code>ActorSystem</code>, but of course you can use your own <code>ActorSystem</code> by overriding <code>AkkaBackend.actorSystem</code></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The <code>AkkaBackend</code> requires a <code>EventsSourceProvider</code> that will be used to query the event store. This is needed for the projections. We&#8217;ll come back to that on the <strong><a href="index.html#_projections">Projections</a></strong> section.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>We declare that <code>Lottery</code> is an Aggregate and pass the behavior method defined in its companion object.</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_using_the_aggregate">Using the Aggregate</h3>
<div class="paragraph">
<p>Once the <code>Lottery</code> aggregate is configured, we request an <code>AggregateRef</code> for a <code>Lottery</code>. Much like in <strong>Akka</strong> where we can&#8217;t have access to the Actor itself, in <strong>Fun.CQRS</strong> we don&#8217;t have direct access to the aggregate. The <code>Lottery</code> aggregate will live inside an actor, but instead of working with its <code>ActorRef</code> we work with a fully typed <code>AggregateRef</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="scala"><span class="tok-k">import</span> <span class="tok-nn">lottery.domain.model.LotteryId</span>
<span class="tok-k">import</span> <span class="tok-nn">lottery.domain.model.LotteryProtocol._</span>

  <span class="tok-k">implicit</span> <span class="tok-k">val</span> <span class="tok-n">timeout</span> <span class="tok-k">=</span> <span class="tok-nc">Timeout</span><span class="tok-o">(</span><span class="tok-mf">3.</span><span class="tok-n">seconds</span><span class="tok-o">)</span>

  <span class="tok-k">val</span> <span class="tok-n">id</span> <span class="tok-k">=</span> <span class="tok-nc">LotteryId</span><span class="tok-o">.</span><span class="tok-n">generate</span><span class="tok-o">()</span>

  <span class="tok-k">val</span> <span class="tok-n">lotteryRef</span> <span class="tok-k">=</span> <span class="tok-n">backend</span><span class="tok-o">.</span><span class="tok-n">aggregateRef</span><span class="tok-o">[</span><span class="tok-kt">Lottery</span><span class="tok-o">](</span><span class="tok-n">id</span><span class="tok-o">)</span> <span class="tok-c1">// </span><i class="conum" data-value="1"></i><b>(1)</b>

  <span class="tok-k">val</span> <span class="tok-n">result</span> <span class="tok-k">=</span>
    <span class="tok-k">for</span> <span class="tok-o">{</span>
      <span class="tok-c1">// create a lottery</span>
      <span class="tok-n">createEvts</span> <span class="tok-k">&lt;-</span> <span class="tok-n">lotteryRef</span> <span class="tok-o">?</span> <span class="tok-nc">CreateLottery</span><span class="tok-o">(</span><span class="tok-s">&quot;Demo&quot;</span><span class="tok-o">)</span> <span class="tok-c1">// </span><i class="conum" data-value="2"></i><b>(2)</b>

      <span class="tok-c1">// add participants </span><i class="conum" data-value="3"></i><b>(3)</b>
      <span class="tok-n">johnEvts</span> <span class="tok-k">&lt;-</span> <span class="tok-n">lotteryRef</span> <span class="tok-o">?</span> <span class="tok-nc">AddParticipant</span><span class="tok-o">(</span><span class="tok-s">&quot;John&quot;</span><span class="tok-o">)</span>
      <span class="tok-n">paulEvts</span> <span class="tok-k">&lt;-</span> <span class="tok-n">lotteryRef</span> <span class="tok-o">?</span> <span class="tok-nc">AddParticipant</span><span class="tok-o">(</span><span class="tok-s">&quot;Paul&quot;</span><span class="tok-o">)</span>
      <span class="tok-n">ringoEvts</span> <span class="tok-k">&lt;-</span> <span class="tok-n">lotteryRef</span> <span class="tok-o">?</span> <span class="tok-nc">AddParticipant</span><span class="tok-o">(</span><span class="tok-s">&quot;Ringo&quot;</span><span class="tok-o">)</span>
      <span class="tok-n">georgeEvts</span> <span class="tok-k">&lt;-</span> <span class="tok-n">lotteryRef</span> <span class="tok-o">?</span> <span class="tok-nc">AddParticipant</span><span class="tok-o">(</span><span class="tok-s">&quot;George&quot;</span><span class="tok-o">)</span>

      <span class="tok-c1">// run the lottery</span>
      <span class="tok-n">runEvts</span> <span class="tok-k">&lt;-</span> <span class="tok-n">lotteryRef</span> <span class="tok-o">?</span> <span class="tok-nc">Run</span> <span class="tok-c1">// </span><i class="conum" data-value="4"></i><b>(4)</b>

    <span class="tok-o">}</span> <span class="tok-k">yield</span> <span class="tok-o">{</span>
      <span class="tok-c1">// concatenate all events together</span>
      <span class="tok-n">createEvts</span> <span class="tok-o">++</span> <span class="tok-n">johnEvts</span> <span class="tok-o">++</span> <span class="tok-n">paulEvts</span> <span class="tok-o">++</span> <span class="tok-n">ringoEvts</span> <span class="tok-o">++</span> <span class="tok-n">georgeEvts</span> <span class="tok-o">++</span> <span class="tok-n">runEvts</span> <span class="tok-c1">// </span><i class="conum" data-value="5"></i><b>(5)</b>
    <span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>(ref: <a href="https://github.com/strongtyped/fun-cqrs/tree/master/samples/lottery/src/main/scala/lottery/app/Main.scala" target="_blank">Main.scala</a>)</p>
</div>
<div class="paragraph">
<p>The <code>lotteryRef</code> can be used to send commands to the aggregate. Since we are using a Akka backend, all calls return a <code>Future</code>. In the event of a successful command, we get back a <code>Future</code> with the list of generated events. Otherwise a failed <code>Future</code> with an exception.</p>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We request a <code>AggregateRef</code> for a <code>Lottery</code> using a unique ID.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We send a create command to the <code>Lottery</code> aggregate via the <code>lotteryRef</code></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>We send four AddParticipant commands for four well-known musicians.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Finally we run the <strong>Lottery</strong></td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>The result is a <code>Future</code> holding all <code>Events</code> concatenated in a single <code>Seq</code> of <code>Events</code>.</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>AggregateRef</code> is <strong>NOT</strong> an <code>ActorRef</code>. However, it does mimic the <code>ActorRef</code> API with methods like '?' (ask) and '!' (tell). This is simply because 'tell' and 'ask' are very idiomatic methods for sending <code>Commands</code>.</p>
</div>
<div class="paragraph">
<p>Behind the scenes the <code>Commands</code> will be forwarded to the right <code>Actor</code> (when using the <code>AkkaBackend</code>) holding the Aggregate instance for the passed Id.</p>
</div>
<div class="paragraph">
<p>When using other backends, the <code>AggregateRef</code> may point to other kind of objects, for instance a service or a in-memory data structure.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_projections">Projections</h2>
<div class="sectionbody">
<div class="paragraph">
<p>TODO - check Lottery sample for the time being</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_akka_backend_configuration">Akka Backend Configuration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>TODO - check Lottery sample for the time being</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_testing">Testing</h2>
<div class="sectionbody">
<div class="paragraph">
<p>TODO - check Lottery sample for the time being</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_project_information">Project Information</h2>
<div class="sectionbody">
<div class="paragraph">
<p><strong>Fun.CQRS</strong> is open source software. Source code is available at:<br>
<a href="https://github.com/strongtyped/fun-cqrs" class="bare">https://github.com/strongtyped/fun-cqrs</a> (development branch)</p>
</div>
<div class="paragraph">
<p>Stable and released branch can be found at:<br>
<a href="https://github.com/strongtyped/fun-cqrs/tree/master" class="bare">https://github.com/strongtyped/fun-cqrs/tree/master</a></p>
</div>
<div class="sect2">
<h3 id="_project_artifact">Project artifact</h3>
<div class="paragraph">
<p>The artifacts are published to Sonatype Repository. Simply add the following to your build.sbt.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="scala"><span class="tok-n">libraryDependencies</span> <span class="tok-o">+=</span> <span class="tok-s">&quot;io.strongtyped&quot;</span> <span class="tok-o">%%</span> <span class="tok-s">&quot;fun-cqrs-akka&quot;</span> <span class="tok-o">%</span> <span class="tok-s">&quot;0.3.0-SNAPSHOT&quot;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If you want to hack <strong>Fun.CQRS</strong> and develop your own backend, you can import only the core module.
The core module does NOT include the Akka backend.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="scala"><span class="tok-n">libraryDependencies</span> <span class="tok-o">+=</span> <span class="tok-s">&quot;io.strongtyped&quot;</span> <span class="tok-o">%%</span> <span class="tok-s">&quot;fun-cqrs-core&quot;</span> <span class="tok-o">%</span> <span class="tok-s">&quot;0.3.0-SNAPSHOT&quot;</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_license">License</h3>
<div class="paragraph">
<p>This software is licensed under the Apache 2 license, quoted below.</p>
</div>
<div class="paragraph">
<p>Licensed under the Apache License, Version 2.0 (the "License"); you may not use this project except in compliance with
the License. You may obtain a copy of the License at <a href="http://www.apache.org/licenses/LICENSE-2.0" class="bare">http://www.apache.org/licenses/LICENSE-2.0</a>.</p>
</div>
<div class="paragraph">
<p>Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on an
"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the specific
language governing permissions and limitations under the License.</p>
</div>
<div class="paragraph">
<p>Copyright 2014 Strong[Typed] (@StrongTyped)</p>
</div>
</div>
<div class="sect2">
<h3 id="_contribution_policy">Contribution policy</h3>
<div class="paragraph">
<p>Contributions via GitHub pull requests are gladly accepted from their original author. Along with any pull requests, please state that the contribution is your original work and that you license the work to the project under the project&#8217;s open source license. Whether or not you state this explicitly, by submitting any copyrighted material via pull request, email, or other means you agree to license the material under the project&#8217;s open source license and warrant that you have the legal authority to do so.</p>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2016-02-11 09:55:42 CET
</div>
</div>
</body>
</html>